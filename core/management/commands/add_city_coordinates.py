from django.core.management.base import BaseCommand
from django.db import transaction
from core.models import City, CityCoordinates


class Command(BaseCommand):
    """
    Command to add coordinates for major Russian cities.
    """
    help = '–î–æ–±–∞–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –†–æ—Å—Å–∏–∏'

    def handle(self, *args, **options):
        """
        Handle command execution.
        
        Args:
            *args: Additional arguments
            **options: Command options
        """
        # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Å–Ω–æ–≤–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –†–æ—Å—Å–∏–∏
        cities_data = {
            '–ú–æ—Å–∫–≤–∞': (55.7558, 37.6176),
            '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥': (59.9311, 30.3609),
            '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫': (55.0084, 82.9357),
            '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥': (56.8519, 60.6122),
            '–ö–∞–∑–∞–Ω—å': (55.8304, 49.0661),
            '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥': (56.2965, 43.9361),
            '–ß–µ–ª—è–±–∏–Ω—Å–∫': (55.1644, 61.4368),
            '–°–∞–º–∞—Ä–∞': (53.2001, 50.1500),
            '–£—Ñ–∞': (54.7388, 55.9721),
            '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É': (47.2357, 39.7015),
            '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä': (45.0355, 38.9753),
            '–ê–Ω–∞–ø–∞': (44.8947, 37.3166),
            '–°–æ—á–∏': (43.6028, 39.7342),
            '–í–æ–ª–≥–æ–≥—Ä–∞–¥': (48.7080, 44.5133),
            '–ü–µ—Ä–º—å': (58.0105, 56.2502),
            '–í–æ—Ä–æ–Ω–µ–∂': (51.6720, 39.1843),
            '–°–∞—Ä–∞—Ç–æ–≤': (51.5924, 46.0347),
            '–¢–æ–ª—å—è—Ç—Ç–∏': (53.5078, 49.4204),
            '–ò–∂–µ–≤—Å–∫': (56.8519, 53.2324),
            '–£–ª—å—è–Ω–æ–≤—Å–∫': (54.3176, 48.3706),
            '–ë–∞—Ä–Ω–∞—É–ª': (53.3548, 83.7698),
            '–ò—Ä–∫—É—Ç—Å–∫': (52.2896, 104.2806),
            '–•–∞–±–∞—Ä–æ–≤—Å–∫': (48.4802, 135.0719),
            '–Ø—Ä–æ—Å–ª–∞–≤–ª—å': (57.6261, 39.8875),
            '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫': (43.1198, 131.8869),
            '–ú–∞—Ö–∞—á–∫–∞–ª–∞': (42.9849, 47.5047),
            '–¢–æ–º—Å–∫': (56.4977, 84.9744),
            '–û—Ä–µ–Ω–±—É—Ä–≥': (51.7727, 55.0988),
            '–ö–µ–º–µ—Ä–æ–≤–æ': (55.3904, 86.0468),
            '–ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫': (53.7945, 87.1848),
            '–†—è–∑–∞–Ω—å': (54.6269, 39.6916),
            '–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å': (46.3589, 48.0506),
            '–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã': (55.7436, 52.3958),
            '–ü–µ–Ω–∑–∞': (53.2007, 45.0046),
            '–õ–∏–ø–µ—Ü–∫': (52.6031, 39.5708),
            '–ö–∏—Ä–æ–≤': (58.6035, 49.6668),
            '–ß–µ–±–æ–∫—Å–∞—Ä—ã': (56.1322, 47.2519),
            '–¢—É–ª–∞': (54.1961, 37.6182),
            '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥': (54.7074, 20.5072),
            '–ö—É—Ä—Å–∫': (51.7373, 36.1873),
            '–£–ª–∞–Ω-–£–¥—ç': (51.8335, 107.5841),
            '–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å': (45.0428, 41.9734),
            '–ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫': (53.4186, 59.0472),
            '–ò–≤–∞–Ω–æ–≤–æ': (57.0004, 40.9739),
            '–ë—Ä—è–Ω—Å–∫': (53.2521, 34.3717),
            '–¢–≤–µ—Ä—å': (56.8587, 35.9006),
            '–ë–µ–ª–≥–æ—Ä–æ–¥': (50.5977, 36.5858),
            '–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫': (64.5473, 40.5602),
            '–í–ª–∞–¥–∏–º–∏—Ä': (56.1296, 40.4066),
            '–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å': (44.6166, 33.5254),
            '–ß–∏—Ç–∞': (52.0515, 113.4719),
            '–ì—Ä–æ–∑–Ω—ã–π': (43.3178, 45.6949),
            '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥': (54.7074, 20.5072),
            '–°–∏–º—Ñ–µ—Ä–æ–ø–æ–ª—å': (44.9572, 34.1108),
        }

        created_count = 0
        updated_count = 0

        with transaction.atomic():
            for city_name, (lat, lng) in cities_data.items():
                # –ò—â–µ–º –≥–æ—Ä–æ–¥ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
                city = City.objects.filter(name=city_name).first()
                
                if city:
                    # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    coords, created = CityCoordinates.objects.get_or_create(
                        city=city,
                        defaults={
                            'latitude': lat,
                            'longitude': lng,
                            'is_active': True
                        }
                    )
                    
                    if created:
                        created_count += 1
                        self.stdout.write(
                            self.style.SUCCESS(
                                f'‚úÖ –°–æ–∑–¥–∞–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è {city_name}: {lat}, {lng}'
                            )
                        )
                    else:
                        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                        coords.latitude = lat
                        coords.longitude = lng
                        coords.is_active = True
                        coords.save()
                        updated_count += 1

        self.stdout.write(
            self.style.SUCCESS(
                f'\nüéâ –û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n'
                f'‚úÖ –°–æ–∑–¥–∞–Ω–æ: {created_count} –∑–∞–ø–∏—Å–µ–π\n'
                f'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ: {updated_count} –∑–∞–ø–∏—Å–µ–π\n'
                f'üìä –í—Å–µ–≥–æ –≥–æ—Ä–æ–¥–æ–≤ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏: {CityCoordinates.objects.count()}'
            )
        ) 