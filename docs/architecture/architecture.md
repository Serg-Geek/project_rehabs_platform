# Архитектура моделей медицинских учреждений

## Обзор

Система медицинских учреждений построена на принципе наследования от абстрактной базовой модели `AbstractMedicalFacility`. Это обеспечивает единообразие в работе с различными типами учреждений и переиспользование кода.

## Иерархия моделей

```
AbstractMedicalFacility (абстрактная базовая модель)
├── Clinic (клиники)
├── RehabCenter (реабилитационные центры)
└── PrivateDoctor (частные врачи)
```

## AbstractMedicalFacility

### Общие поля для всех учреждений

- `name` - название учреждения
- `slug` - URL-идентификатор
- `organization_type` - тип организации (FK к OrganizationType)
- `description` - описание
- `address` - адрес
- `phone` - телефон
- `email` - email
- `website` - веб-сайт
- `license_number` - номер лицензии
- `is_active` - активность
- `city` - город (FK к City)

### Общие возможности

- **Отзывы** - система рейтингов и отзывов
- **Документы** - лицензии, сертификаты, аккредитации
- **Изображения** - галереи и фотографии
- **Специалисты** - привязка к учреждению через GenericForeignKey

## OrganizationType

Типы организаций в системе:

- `clinic` - Клиника
- `rehabilitation-center` - Реабилитационный центр
- `private-doctor` - Частный врач

## Clinic

### Специфические поля

- `emergency_support` - экстренная помощь
- `has_hospital` - наличие стационара

### Использование

Клиники предназначены для стационарного и амбулаторного лечения с возможностью экстренной помощи.

## RehabCenter

### Специфические поля

- `capacity` - вместимость
- `program_duration` - длительность программы (дней)
- `min_price` - минимальная цена
- `accommodation_conditions` - условия проживания

### Использование

Реабилитационные центры специализируются на длительных программах восстановления с проживанием.

## PrivateDoctor

### Специфические поля

#### Персональная информация

- `first_name`, `last_name`, `middle_name` - ФИО
- `specializations` - специализации (M2M к Specialization)
- `experience_years` - стаж
- `education` - образование
- `biography` - биография
- `achievements` - достижения
- `photo` - фото

#### Место приема

- `office_description` - описание кабинета
- `parking_available` - наличие парковки
- `wheelchair_accessible` - доступность для инвалидных колясок

#### График работы

- `schedule` - график работы
- `home_visits` - выезд на дом
- `emergency_available` - экстренная помощь
- `weekend_work` - работа в выходные

#### Финансовые аспекты

- `consultation_price` - стоимость консультации
- `home_visit_price` - стоимость выезда на дом
- `insurance_accepted` - принимает страховку

#### Лицензирование

- `license_issue_date` - дата выдачи лицензии
- `license_expiry_date` - срок действия лицензии

#### Дополнительные возможности

- `online_consultations` - онлайн консультации
- `video_consultations` - видеоконсультации
- `special_equipment` - специальное оборудование

### Использование

Частные врачи - это индивидуальные специалисты, не привязанные к конкретным учреждениям.

## Модуль заявок (requests)

### Обзор

Модуль заявок обеспечивает обработку обращений от клиентов и зависимых лиц. Система поддерживает два типа заявок с полным жизненным циклом, включая назначение учреждений, отслеживание статусов и ведение истории изменений.

### Основные модели

#### AnonymousRequest (Анонимные заявки)

**Назначение**: Обработка заявок от анонимных пользователей через веб-формы, телефонные звонки и другие каналы связи.

**Ключевые поля**:

- `request_type` - тип заявки (консультация, лечение, реабилитация, партнерство, другое)
- `status` - статус обработки (новая, в обработке, ожидание комиссии, комиссия получена, лечение начато, лечение завершено, отменена, закрыта)
- `priority` - приоритет (низкий, средний, высокий, срочный)
- `source` - источник заявки (веб-форма, телефонный звонок, email, очное обращение, другое)
- `name`, `phone`, `email` - контактная информация
- `organization_type` - тип назначенной организации (FK к OrganizationType)
- `assigned_organization` - название назначенной организации
- `commission_amount`, `commission_received_date` - информация о комиссии
- `created_by`, `updated_by`, `assigned_to` - пользователи системы

**Устаревшие поля** (не использовать в новых разработках):

- `content_type`, `object_id`, `preferred_facility` - заменены на `organization_type` и `assigned_organization`

#### DependentRequest (Заявки от зависимых)

**Назначение**: Специализированная обработка заявок от лиц с зависимостями с учетом конфиденциальности и специфики лечения.

**Ключевые поля**:

- `addiction_type` - тип зависимости (алкоголь, наркотики, игровая зависимость, другое)
- `contact_type` - тип контакта (анонимно, под псевдонимом, под реальным именем)
- `status` - статус обработки (аналогично AnonymousRequest)
- `first_name`, `last_name`, `pseudonym` - персональная информация
- `phone`, `email` - контактная информация
- `age`, `addiction_duration` - медицинская информация
- `previous_treatment`, `current_condition`, `preferred_treatment` - медицинские данные
- `emergency_contact`, `emergency_phone` - контактное лицо
- `responsible_staff` - ответственный сотрудник
- `organization_type`, `assigned_organization` - назначенное учреждение

### Вспомогательные модели

#### RequestNote / DependentRequestNote (Заметки)

**Назначение**: Добавление заметок к заявкам для внутреннего использования сотрудниками.

**Поля**:

- `request` - связь с заявкой
- `text` - текст заметки
- `is_important` - флаг важности
- `created_by` - автор заметки
- `created_at`, `updated_at` - временные метки

#### RequestStatusHistory / DependentRequestStatusHistory (История статусов)

**Назначение**: Отслеживание изменений статуса заявок для аудита и анализа.

**Поля**:

- `request` - связь с заявкой
- `old_status`, `new_status` - предыдущий и новый статус
- `comment` - комментарий к изменению
- `changed_at` - время изменения
- `changed_by` - пользователь, изменивший статус

#### RequestActionLog (Лог действий)

**Назначение**: Детальное логирование всех действий с анонимными заявками.

**Поля**:

- `request` - связь с заявкой
- `user` - пользователь системы
- `action` - тип действия (создание, обновление, изменение статуса, комиссия, заметка, назначение, другое)
- `details` - детали действия
- `created_at`, `updated_at` - временные метки

### Интеграция с другими модулями

#### Связь с учреждениями

- **OrganizationType**: Тип организации определяет доступные учреждения для назначения
- **assigned_organization**: Поле для хранения названия конкретного назначенного учреждения
- **Динамический выбор**: В админке реализован динамический выбор организаций на основе типа

#### Связь с пользователями

- **created_by**: Пользователь, создавший заявку
- **updated_by**: Пользователь, последний раз обновивший заявку
- **assigned_to**: Пользователь, назначенный для обработки заявки
- **responsible_staff**: Ответственный сотрудник (для DependentRequest)
- **changed_by**: Пользователь, изменивший статус
- **created_by** (заметки): Автор заметки

### Жизненный цикл заявки

1. **Создание**: Заявка создается через веб-форму или администратором
2. **Назначение**: Выбирается тип организации и конкретное учреждение
3. **Обработка**: Заявка проходит через различные статусы
4. **Комиссия**: При необходимости оформляется комиссия
5. **Завершение**: Заявка закрывается после завершения лечения

### Автоматизация

- **Автоматическое заполнение**: Поля `created_by`, `updated_by` заполняются автоматически
- **История статусов**: Изменения статуса автоматически записываются в историю
- **Логирование действий**: Все действия с заявками логируются
- **Валидация**: Проверка обязательных полей и бизнес-правил

### Преимущества архитектуры

#### 1. Разделение ответственности

- Анонимные заявки и заявки от зависимых имеют разную логику
- Специализированные поля для каждого типа
- Раздельные модели для заметок и истории

#### 2. Гибкость назначения

- Динамический выбор учреждений
- Поддержка различных типов организаций
- Возможность изменения назначения

#### 3. Полная трассируемость

- История всех изменений статуса
- Логирование действий пользователей
- Аудит назначений и обработки

#### 4. Масштабируемость

- Легко добавить новые типы заявок
- Расширяемая система статусов
- Гибкая система заметок

## Преимущества архитектуры

### 1. Единообразие

- Все учреждения имеют одинаковую базовую структуру
- Единый подход к отзывам, документам, изображениям

### 2. Переиспользование кода

- Общие поля и методы в базовой модели
- Единая админка для всех типов учреждений

### 3. Расширяемость

- Легко добавить новые типы учреждений
- Изменения в базовой модели применяются ко всем наследникам

### 4. Консистентность

- Одинаковый API для всех учреждений
- Единые URL-паттерны и представления

## Миграции

При добавлении новых типов учреждений:

1. Создать новый тип в `OrganizationType`
2. Создать модель, наследующую от `AbstractMedicalFacility`
3. Добавить специфические поля
4. Создать миграцию
5. Обновить админку и представления

## Примеры использования

### Получение всех активных учреждений

```python
from facilities.models import Clinic, RehabCenter, PrivateDoctor

all_facilities = list(Clinic.objects.filter(is_active=True)) + \
                 list(RehabCenter.objects.filter(is_active=True)) + \
                 list(PrivateDoctor.objects.filter(is_active=True))
```

### Получение учреждений по типу

```python
from facilities.models import OrganizationType

clinic_type = OrganizationType.objects.get(slug='clinic')
clinics = Clinic.objects.filter(organization_type=clinic_type)
```

### Работа с отзывами

```python
# Все отзывы учреждения
facility.reviews.all()

# Средний рейтинг
facility.average_rating

# Количество отзывов
facility.reviews_count
```

### Работа с заявками

```python
from requests.models import AnonymousRequest, DependentRequest

# Получение заявок по статусу
new_requests = AnonymousRequest.objects.filter(status='new')

# Получение заявок по типу организации
clinic_requests = AnonymousRequest.objects.filter(
    organization_type__name='Клиника'
)

# Получение заявок с историей статусов
requests_with_history = AnonymousRequest.objects.prefetch_related(
    'status_history'
).all()

# Получение заявок от зависимых по типу зависимости
alcohol_requests = DependentRequest.objects.filter(
    addiction_type='alcohol'
)
```
